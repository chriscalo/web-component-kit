<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI Icon Component Tests</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
    }
    .icon-demo {
      display: flex;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: white;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <h1>UI Icon Component Tests</h1>

  <!-- Initialize window.tests BEFORE any module scripts load -->
  <script>
    window.tests = [];
  </script>

  <h2>Icon Demos</h2>
  <div id="icon-demos"></div>

  <!-- Include the ui-icon component -->
  <wck-include src="./ui-icon.component.html"></wck-include>

  <!-- Test: Component Registration -->
  <script type="module" name="component-registration-test">
    import { componentsReady } from "./index.js";

    // Initialize tests array
    if (!window.tests) window.tests = [];

    // Wait for component to be ready (processIncludes is called automatically by index.js)
    try {
      await componentsReady("ui-icon");

      window.tests.push({
        name: "ui-icon component is registered",
        async run() {
          const UiIcon = customElements.get("ui-icon");
          if (!UiIcon) {
            throw new Error("ui-icon component not registered");
          }
          const icon = document.createElement("ui-icon");
          if (!(icon instanceof UiIcon)) {
            throw new Error("Created element is not an instance of UiIcon");
          }
        }
      });
    } catch (error) {
      console.error("Failed to load ui-icon component:", error);
      window.tests.push({
        name: "ui-icon component is registered",
        async run() {
          throw new Error(`Component loading failed: ${error.message}`);
        }
      });
    }
  </script>

  <!-- Test: Default Attributes -->
  <script type="module" name="default-attributes-test">
    window.tests.push({
      name: "ui-icon has correct default attributes",
      async run() {
        const icon = document.createElement("ui-icon");

        if (icon.library !== "lucide") {
          throw new Error(`Expected library 'lucide', got '${icon.library}'`);
        }
        if (icon.type !== "filled") {
          throw new Error(`Expected type 'filled', got '${icon.type}'`);
        }
        if (icon.size !== "24") {
          throw new Error(`Expected size '24', got '${icon.size}'`);
        }
        if (icon.color !== "currentColor") {
          throw new Error(`Expected color 'currentColor', got '${icon.color}'`);
        }
        if (icon.strokeWidth !== "2") {
          throw new Error(`Expected strokeWidth '2', got '${icon.strokeWidth}'`);
        }
      }
    });
  </script>

  <!-- Test: Custom Attributes -->
  <script type="module" name="custom-attributes-test">
    window.tests.push({
      name: "ui-icon accepts custom attributes",
      async run() {
        const icon = document.createElement("ui-icon");
        icon.setAttribute("name", "home");
        icon.setAttribute("size", "32");
        icon.setAttribute("color", "red");
        icon.setAttribute("stroke-width", "3");

        if (icon.name !== "home") {
          throw new Error(`Expected name 'home', got '${icon.name}'`);
        }
        if (icon.size !== "32") {
          throw new Error(`Expected size '32', got '${icon.size}'`);
        }
        if (icon.color !== "red") {
          throw new Error(`Expected color 'red', got '${icon.color}'`);
        }
        if (icon.strokeWidth !== "3") {
          throw new Error(`Expected strokeWidth '3', got '${icon.strokeWidth}'`);
        }
      }
    });
  </script>

  <!-- Test: Icon Href Generation -->
  <script type="module" name="icon-href-test">
    window.tests.push({
      name: "ui-icon generates correct href",
      async run() {
        const icon = document.createElement("ui-icon");
        icon.setAttribute("name", "search");

        if (icon.iconHref !== "#lucide-search") {
          throw new Error(`Expected iconHref '#lucide-search', got '${icon.iconHref}'`);
        }

        icon.setAttribute("library", "custom");
        icon.setAttribute("name", "star");

        if (icon.iconHref !== "#custom-star") {
          throw new Error(`Expected iconHref '#custom-star', got '${icon.iconHref}'`);
        }
      }
    });
  </script>

  <!-- Test: Style Properties -->
  <script type="module" name="style-properties-test">
    window.tests.push({
      name: "ui-icon sets CSS custom properties",
      async run() {
        const icon = document.createElement("ui-icon");
        icon.setAttribute("name", "settings");
        icon.setAttribute("size", "48");
        icon.setAttribute("color", "blue");
        icon.setAttribute("stroke-width", "1");

        document.body.appendChild(icon);
        await new Promise(resolve => setTimeout(resolve, 10));

        if (icon.style.getPropertyValue("--size") !== "48") {
          throw new Error(`Expected --size '48', got '${icon.style.getPropertyValue("--size")}'`);
        }
        if (icon.style.getPropertyValue("--color") !== "blue") {
          throw new Error(`Expected --color 'blue', got '${icon.style.getPropertyValue("--color")}'`);
        }
        if (icon.style.getPropertyValue("--stroke-width") !== "1") {
          throw new Error(`Expected --stroke-width '1', got '${icon.style.getPropertyValue("--stroke-width")}'`);
        }

        document.body.removeChild(icon);
      }
    });
  </script>

  <!-- Test: SVG Rendering -->
  <script type="module" name="svg-rendering-test">
    window.tests.push({
      name: "ui-icon renders SVG element",
      async run() {
        const icon = document.createElement("ui-icon");
        icon.setAttribute("name", "user");

        document.body.appendChild(icon);
        await new Promise(resolve => setTimeout(resolve, 10));

        const svg = icon.querySelector("svg");
        if (!svg) {
          throw new Error("SVG element should exist");
        }
        if (svg.getAttribute("viewBox") !== "0 0 24 24") {
          throw new Error(`Expected viewBox '0 0 24 24', got '${svg.getAttribute("viewBox")}'`);
        }
        if (svg.getAttribute("role") !== "presentation") {
          throw new Error(`Expected role 'presentation', got '${svg.getAttribute("role")}'`);
        }

        const use = svg.querySelector("use");
        if (!use) {
          throw new Error("Use element should exist");
        }
        if (!use.getAttribute("href").includes("lucide-user")) {
          throw new Error(`Expected href to include 'lucide-user', got '${use.getAttribute("href")}'`);
        }

        document.body.removeChild(icon);
      }
    });
  </script>

  <!-- Test: Attribute Changes Update Component -->
  <script type="module" name="attribute-changes-test">
    window.tests.push({
      name: "ui-icon updates on attribute change",
      async run() {
        const icon = document.createElement("ui-icon");
        icon.setAttribute("name", "home");
        icon.setAttribute("size", "24");

        document.body.appendChild(icon);
        await new Promise(resolve => setTimeout(resolve, 10));

        if (icon.style.getPropertyValue("--size") !== "24") {
          throw new Error(`Expected --size '24', got '${icon.style.getPropertyValue("--size")}'`);
        }

        icon.setAttribute("size", "36");
        await new Promise(resolve => setTimeout(resolve, 10));

        if (icon.style.getPropertyValue("--size") !== "36") {
          throw new Error(`Expected --size '36' after update, got '${icon.style.getPropertyValue("--size")}'`);
        }

        document.body.removeChild(icon);
      }
    });
  </script>

  <!-- Demo Icons -->
  <script type="module" name="demo-icons">
    function createDemos() {
      const demoContainer = document.getElementById("icon-demos");

      const icons = [
        { name: "home", size: "24", color: "black" },
        { name: "search", size: "32", color: "blue" },
        { name: "settings", size: "48", color: "green" },
        { name: "user", size: "16", color: "red" },
        { name: "mail", size: "24", color: "purple", strokeWidth: "1" },
        { name: "heart", size: "32", color: "pink", strokeWidth: "3" }
      ];

      icons.forEach(config => {
        const demo = document.createElement("div");
        demo.className = "icon-demo";

        const icon = document.createElement("ui-icon");
        Object.entries(config).forEach(([key, value]) => {
          if (key === "strokeWidth") {
            icon.setAttribute("stroke-width", value);
          } else {
            icon.setAttribute(key, value);
          }
        });

        const label = document.createElement("span");
        label.textContent = `${config.name} (${config.size}px, ${config.color})`;

        demo.appendChild(icon);
        demo.appendChild(label);
        demoContainer.appendChild(demo);
      });
    }

    // Create demos after a brief delay to ensure tests have loaded
    setTimeout(createDemos, 100);
  </script>

  <!-- Test Runner - Run all tests and log results -->
  <script type="module">
    // Ensure tests array exists
    if (!window.tests) window.tests = [];

    // Wait for all imports and module scripts to complete
    await new Promise(resolve => {
      if (document.readyState === 'complete') {
        setTimeout(resolve, 100);
      } else {
        window.addEventListener('load', () => setTimeout(resolve, 100));
      }
    });

    console.log(`Loaded ${window.tests.length} tests`);
    window.testsReady = true;

    // Run all tests and log results (for Node.js test runner compatibility)
    for (const test of window.tests) {
      try {
        await test.run();
        console.log(`✅ ${test.name}`);
      } catch (error) {
        console.error(`❌ ${test.name}:`, error.message);
      }
    }

    // Summary
    console.log(`\n📊 Test Summary: ${window.tests.length}/${window.tests.length} tests executed`);
  </script>
</body>
</html>
